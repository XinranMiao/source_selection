---
title: "Visualizing bandit selection"
params:
  path: "derived_data/chtc_0730/"
output:
  html_document:
    df_print: paged
---

```{r}
library(tidyverse)
bandit_theme <- theme_bw() +
  theme(axis.title = element_text(face = "bold", size = 13),
        strip.text = element_text(face = "bold", size = 12),
        legend.title = element_text(face = "bold", size = 12),
        legend.text = element_text(size = 12))
```


```{r}
result_list <- list()
tar_ball_paths <- list.files(params$path, pattern = "*tar.gz")
i <- 1
for(tar_ball_path in tar_ball_paths) {
  split_name <- tar_ball_path %>% str_remove(".tar.gz") %>% str_split("_") %>% unlist
  path <- str_c(params$path, tar_ball_path)
  untar(path, exdir = params$path)
  
  if (dir.exists(str_c(params$path, "derived_data/"))) {
    result_list[[i]] <- read.csv(str_c(params$path, "derived_data/", list.files(str_c(params$path, "derived_data", ""), pattern = "train_log.csv"))) %>%
    mutate(target_target = split_name[length(split_name) - 2],
           algorithm = split_name[length(split_name) - 1],
           target_size = split_name[length(split_name)] %>% as.numeric()) %>%
      rename(epoch = "X")
  i <- i + 1
  system("rm -r derived_data/chtc_0730/derived_data")
  }
  
}
```


### Check the train / validation accuracy over bandit selection iterations.
```{r}
bind_rows(result_list) %>%
  tail
```
```{r}
bind_rows(result_list) %>%
  filter(epoch == 49) %>%
  pivot_longer(c(train_acc, val_acc), names_to = "set", values_to = "accuracy") %>%
  ggplot() +
  geom_point(aes(x = iter, y = accuracy, color = algorithm, shape = set)) +
  facet_grid(target_task ~ target_size) +
  bandit_theme
```

### Within iterations - model performance over epochs
```{r}
bind_rows(result_list) %>%
  filter(iter %% 20 ==0,
         target_size == 320) %>%
  pivot_longer(c(train_acc, val_acc), names_to = "set", values_to = "accuracy") %>%
  mutate(combination = str_c(algorithm, "_", set)) %>%
  ggplot +
  geom_point(aes(x = epoch, y = accuracy,  color = combination)) +
    facet_grid(target_task ~ iter) +
  bandit_theme
```


### Test accuracy
```{r}
test_acc <- read.csv(str_c(params$path, "test_acc.csv"))
test_acc %>%
  ggplot +
  geom_point(aes(x = target_task, y = test_acc, color = algorithm), size = 2) +
  facet_wrap(~ target_size) +
  bandit_theme
```

