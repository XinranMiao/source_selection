---
title: "Visualizing simulation"
params:
  data_path: "derived_data/model_nn/conservative_derived_data"
output:
  html_document:
    df_print: paged
---
```{r}
library(tidyverse)
library(viridis)
theme_set(theme_bw() +
            theme(plot.title = element_text(hjust = 0.5),
      axis.text = element_text(size = 13), # Font size of axis labels.
      legend.text = element_text(size = 15),  # Font size of legend labels.
      title = element_text(size = 15),
      strip.text = element_text(size = 13, face = "bold")))
```


## Simulated data
```{r}
data_path <- params$data_path
dirs <- list.dirs(recursive = TRUE)
dirs <- dirs[grepl("bw$", dirs)]
for (p in dirs) {
  betas <- read_csv(str_c(p, "/betas.csv"))
  x <- read_csv(str_c(p, "/tasks_processed.csv"))
  ggplot(x %>% left_join(betas %>% select(task, cluster))) + 
    geom_point(aes(x, y, col = as.factor(cluster)), size = 2) + 
    facet_wrap(~ task, scales = "free")
  ggsave(filename = str_c(p, "/processed_data.png"), width = 10, height = 8)
  
  
  x <- read_csv(str_c(p, "/tasks.csv"))
  ggplot(x %>% left_join(betas %>% select(task, cluster))) + 
    geom_point(aes(x, y, col = as.factor(cluster)), size = 2) + 
    facet_wrap(~ task, scales = "free")
  ggsave(filename = str_c(p, "/Raw_data.png"), width = 10, height = 8)
}

```

## Bandit selection results

```{r}
bandit_output_dirs <- list.dirs(data_path)
```
```{r}
extract_info <- function(d, betas) {
  str_sp <- str_split(d, "/", simplify = TRUE) %>% str_split("_", simplify = TRUE)
  target_task <- str_sp[nrow(str_sp), 2]
  target_cluster <- betas %>% filter(task == target_task) %>% select(cluster) %>% unique %>% unlist
  
  row_sigma <- which(str_sp[, 2] == "bw")
  row_target <- which(str_sp[, 1] == "target")
  row_model <- which(str_sp[, 1] == "model")
  
  model_setting <- str_sp[row_model, 2]
  sigma_setting <- str_sp[row_sigma, 1]
  target_test_size <- str_sp[row_target, 3]
  
  if("conservative" %in% unlist(str_sp)) {
    conservative = TRUE
  } else{
    conservative = FALSE
  }
    
  
  return(list(target_cluster = target_cluster,
              target_bandit = target_task,
              sigma_setting = sigma_setting,
              target_test_size  = target_test_size,
              model_setting = model_setting,
              conservative = conservative))
}
```

```{r}
baselines <- list()
for(d in bandit_output_dirs) {
  if(!  str_detect(d, "target")) {
    next
  }
  # extract information about target (which task, which cluster)
  betas <- read_csv(str_c(d, "/../betas.csv"))
  info <- extract_info(d, betas)
  target_cluster <- info$target_cluster
  target_bandit <- info$target_bandit
  sigma_setting <- info$sigma_setting
  target_test_size <- info$target_test_size 
  # read data
  losses <- read.csv(str_c(d, "/losses.csv")) %>%
    rename(iteration = X) %>%
          rename(value = losses,
                 task = bandit_selects) %>%
          mutate(parameter = "loss")
  
  alpha <- read.csv(str_c(d, "/alpha.csv")) %>%
    rename(iteration = X) %>% 
    pivot_longer(!"iteration", names_to = "bandit", values_to = "value") %>%
    mutate(parameter = "alpha")
  beta <- read.csv(str_c(d, "/beta.csv")) %>%
    rename(iteration = X) %>% 
    pivot_longer(!"iteration", names_to = "bandit", values_to = "value") %>%
    mutate(parameter = "beta")
  pi <- read.csv(str_c(d, "/pi.csv")) %>%
    rename(iteration = X) %>% 
    pivot_longer(!"iteration", names_to = "bandit", values_to = "value") %>%
    mutate(parameter = "pi") %>%
    rename(task = bandit) %>%
    mutate(task = str_remove_all(task, "X") %>% as.numeric())
  
  baselines[[d]] <- read.csv(str_c(d, "/baseline.csv")) %>%
    select(- X) %>%
    mutate(target_bandit = target_bandit,
           target_cluster = target_cluster,
           sigma_setting = sigma_setting,
           target_test_size  = target_test_size )
    
    
  losses %>%
    group_by(task) %>%
    summarise(loss = mean(value))
  losses %>%
    mutate(task = as.factor(task)) %>%
    drop_na() %>%
    ggplot() +
    geom_point(aes(x = iteration, y = value, color = task), size = 2) +
    geom_path(aes(x = iteration, y = value)) +
    ggtitle(str_c("target cluster is ", target_cluster, ", task is ",target_bandit)) +
    geom_hline(yintercept = losses[1, "value"], color = "red")
  ggsave(filename = str_c(d, "/losses.png"), width = 7, height = 7)
  
  pi  %>%
    mutate(task = as.factor(task)) %>%
    ggplot() +
    geom_point(aes(x = iteration, y = value, color = task)) +
    geom_path(aes(x = iteration, y = value, color = task)) +
    ggtitle(str_c("target bandit is ", target_bandit))
  ggsave(filename = str_c(d, "/pi.png"), width = 7, height = 7)
  
  alpha %>% 
    ggplot() +
    geom_point(aes(x = iteration, y = value, color = bandit)) +
    geom_path(aes(x = iteration, y = value, color = bandit)) +
    ggtitle(str_c("target bandit is ", target_bandit)) +
    labs(y = "alpha")
  ggsave(filename = str_c(d, "/alpha.png"), width = 7, height = 7)
  
  beta %>% 
    ggplot() +
    geom_point(aes(x = iteration, y = value, color = bandit)) +
    geom_path(aes(x = iteration, y = value, color = bandit)) +
    ggtitle(str_c("target bandit is ", target_bandit)) +
    labs(y = "beta")
  ggsave(filename = str_c(d, "/beta.png"), width = 7, height = 7)
  
  # visualize parameters and losses
  rbind(alpha, beta) %>%
    mutate(task = str_remove_all(bandit, "X") %>% as.numeric()) %>%
    select(-bandit) %>%
    rbind(losses) %>%
    rbind(pi) %>%
    full_join(betas[, c("task", "cluster")], by = "task") %>%
    mutate(task = as.factor(task),
         cluster = as.factor(cluster)) %>%
    drop_na() %>%
    ggplot() +
    geom_point(aes(x = iteration, y =value, color = task), size = 2) +
    facet_grid( parameter ~ cluster, scales = "free") +
    ggtitle(str_c("target cluster is ", target_cluster, "; target task is ", target_bandit))
  
  ggsave(filename = str_c(d, "/parameter.png"), width = 10, height = 8)
}
```


```{r}

baselines <- list()
for(d in bandit_output_dirs) {
  if(!  str_detect(d, "target")) {
    next
  }
  # extract information about target (which task, which cluster)
  betas <- read_csv(str_c(d, "/../betas.csv"))
  info <- extract_info(d, betas)
  target_cluster <- info$target_cluster
  target_bandit <- info$target_bandit
  sigma_setting <- info$sigma_setting
  target_test_size <- info$target_test_size 
  baselines[[d]] <- read.csv(str_c(d, "/baseline.csv")) %>%
    select(- X) %>%
    mutate(target_bandit = target_bandit,
           target_cluster = target_cluster,
           sigma_setting = sigma_setting,
           target_test_size  = target_test_size,
           model_setting = info$model_setting,
           conservative = info$conservative)
}

# Comparison with baselines
for (sigma_set in c("high", "low", "medium")) {
  bind_rows(baselines) %>%
    mutate(target_train_size = 1 - as.numeric(target_test_size)) %>%
    filter(sigma_setting == sigma_set,
           #conservative == TRUE,
           #model_setting == "nn"
           ) %>%
    pivot_longer(cols = c("bandit", "all_source", "target_train", "random_source"),
               names_to = "method",
               values_to = "loss")  %>%
    ggplot() +
    facet_wrap(target_train_size ~. ) +
    geom_tile(aes(x = method, y = target_bandit, fill = log(loss)) )+
    labs(x = "Method", y = "Target task") +
    scale_fill_viridis(begin = 1, end = 0)
  
  ggsave(filename = str_c(data_path, "/", sigma_set, "_bw/heat_baseline.png"), width = 12, height = 7)
}

```
